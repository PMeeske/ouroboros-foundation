# Notify downstream repositories when CI passes on main
# Triggers ouroboros-engine and ouroboros-app to update their submodule references

name: Notify Downstream

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  notify:
    name: Notify Downstream Repos
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Dispatch to ouroboros-engine
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.OUROBOROS_DISPATCH_PAT }}
          repository: PMeeske/ouroboros-engine
          event-type: dependency-updated
          client-payload: |
            {
              "source_repo": "ouroboros-foundation",
              "source_sha": "${{ github.event.workflow_run.head_sha }}"
            }

      - name: Dispatch to ouroboros-app
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.OUROBOROS_DISPATCH_PAT }}
          repository: PMeeske/ouroboros-app
          event-type: dependency-updated
          client-payload: |
            {
              "source_repo": "ouroboros-foundation",
              "source_sha": "${{ github.event.workflow_run.head_sha }}"
            }
